% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/sim_boin.R
\name{sim_boin}
\alias{sim_boin}
\title{Run BOIN Simulation}
\usage{
sim_boin(
  n_trials = 10000,
  target,
  p_true,
  n_doses,
  n_cohort,
  cohort_size,
  n_earlystop = 18,
  cutoff_eli = 0.95,
  extrasafe = FALSE,
  offset = 0.05,
  min_mtd_sample = 6,
  boundMTD = FALSE,
  n_earlystop_rule = c("simple", "with_stay"),
  seed = 123
)
}
\arguments{
\item{n_trials}{Numeric. Number of trials to simulate. Default is 10000.
Typically 1000-10000 for detailed operating characteristics.}

\item{target}{Numeric. The target toxicity probability (e.g., 0.30 for 30\%).}

\item{p_true}{Numeric vector. True toxicity probabilities for each dose.
Length determines number of doses evaluated.}

\item{n_doses}{Numeric. Number of doses evaluated.}

\item{n_cohort}{Numeric. Maximum number of cohorts per trial.}

\item{cohort_size}{Numeric vector or scalar specifying patients per cohort.
If vector (e.g., c(4, 3, 3)), each element specifies size for corresponding cohort.
If scalar, all cohorts use the same size.}

\item{n_earlystop}{Numeric. Sample size at current dose triggering trial termination.
Default is 18. This is also used as the maximum sample size for decision table
generation.}

\item{cutoff_eli}{Numeric. Cutoff probability for dose elimination. Default is 0.95.
If Pr(toxicity > target | data) > cutoff_eli, eliminate the dose and higher doses.}

\item{extrasafe}{Logical. If TRUE, apply additional safety stopping rule at the
lowest dose. Default is FALSE. When TRUE, the trial stops early if the lowest
dose is overly toxic based on \code{cutoff_eli - offset}.}

\item{offset}{Numeric. Offset for safety stopping boundary when \code{extrasafe = TRUE}.
Default is 0.05. The safety cutoff becomes \code{cutoff_eli - offset}.}

\item{min_mtd_sample}{Numeric. Minimum sample size for MTD consideration. Default is 6.}

\item{boundMTD}{Logical. If TRUE, impose the condition that the isotonic estimate of
toxicity probability for the selected MTD must be less than the de-escalation boundary.
Default is FALSE. This provides a more conservative MTD selection.}

\item{n_earlystop_rule}{Character. Rule for early stopping at n_earlystop.
Options are "simple" (stop when n >= n_earlystop) or "with_stay" (stop when
n >= n_earlystop AND decision = "Stay"). Default is "simple" for backward compatibility.
"with_stay" follows the BOIN standard implementation.}

\item{seed}{Numeric. Random seed for reproducibility. Default is 123.}
}
\value{
A list containing:
\item{detailed_results}{List of results from each individual trial}
\item{summary}{Aggregated summary statistics from \code{summarize_simulation_boin()}}
}
\description{
Execute multiple BOIN trial simulations using optimized batch processing for
computational efficiency. The function automatically generates decision tables
and stopping boundaries based on the target toxicity rate and design parameters,
then processes all trials simultaneously at each cohort for maximum performance.

This implementation is particularly beneficial for large-scale simulations
(e.g., 10,000+ trials) where computational efficiency is critical for practical
protocol development and regulatory submissions.
}
\details{
This function implements an optimized approach to BOIN simulation:
\enumerate{
\item Generate BOIN boundaries using \code{get_boin_boundary(target)}
\item Generate decision table using \code{get_boin_decision()}
\item If \code{extrasafe = TRUE}, generate safety stopping boundaries
\item Initialize matrices to store state for all trials simultaneously
\item Loop over cohorts (not trials), processing all active trials at each cohort
\item Generate DLT data for all active trials in a single \code{rbinom()} call
\item Apply dose decisions using vectorized matrix operations
\item Perform MTD selection using optimized batch processing
}

The optimized approach reduces the number of iterations from
\code{n_trials * n_cohort} to just \code{n_cohort}, while processing
all trials simultaneously using matrix operations. This typically provides
2-5x speedup compared to traditional sequential loop-based approaches.

\strong{Key Performance Features:}
\itemize{
\item Automatic generation of decision tables and boundaries
\item Single random number generation for all trials per cohort
\item Matrix-based decision table lookups via vectorized indexing
\item Batch isotonic regression and MTD selection
\item Early termination of inactive trials to reduce overhead
}

\strong{Safety Stopping Rule:}
When \code{extrasafe = TRUE}, the trial implements an additional safety rule:
if the lowest dose shows excessive toxicity based on posterior probability
Pr(toxicity > target | data) > \code{cutoff_eli - offset}, the entire trial
stops for safety. This rule requires at least 3 patients at the lowest dose.

\strong{boundMTD:}
When \code{boundMTD = TRUE}, the selected MTD must satisfy the condition that
its isotonic-estimated toxicity rate is below the de-escalation boundary.
This provides a more conservative MTD selection, ensuring the selected dose
is not too close to overly toxic doses.

\strong{n_earlystop_rule:}
\itemize{
\item "simple": Stop when n >= n_earlystop (default, backward compatible)
\item "with_stay": Stop when n >= n_earlystop AND next decision = "Stay".
This follows the BOIN standard implementation and ensures the algorithm
has converged before stopping.
}

\strong{Memory Usage:} The function maintains \code{n_trials x n_doses} matrices
for patient counts, DLT counts, and elimination status. For typical
simulations (10000 trials, 5-9 doses), memory usage is negligible on
modern systems (<100MB).
}
\examples{
\dontrun{
# Basic BOIN simulation (backward compatible)
result <- sim_boin(
  n_trials = 10000,
  target = 0.30,
  p_true = c(0.10, 0.25, 0.40, 0.55, 0.70),
  n_doses = 5,
  n_cohort = 10,
  cohort_size = 3,
  seed = 123
)

# With BOIN standard implementation (boundMTD + with_stay)
result_standard <- sim_boin(
  n_trials = 10000,
  target = 0.30,
  p_true = c(0.10, 0.25, 0.40, 0.55, 0.70),
  n_doses = 5,
  n_cohort = 10,
  cohort_size = 3,
  boundMTD = TRUE,
  n_earlystop_rule = "with_stay",
  seed = 123
)

# Conservative design with extra safety
result_conservative <- sim_boin(
  n_trials = 10000,
  target = 0.30,
  p_true = seq(0.05, 0.45, by = 0.05),
  n_doses = 9,
  n_cohort = 48,
  cohort_size = 3,
  extrasafe = TRUE,
  boundMTD = TRUE,
  n_earlystop_rule = "with_stay",
  seed = 123
)
}

}
\references{
Liu S. and Yuan, Y. (2015). Bayesian Optimal Interval Designs for Phase I Clinical
Trials. Journal of the Royal Statistical Society: Series C, 64, 507-523.
}
\seealso{
\code{\link{get_boin_boundary}} for BOIN boundary calculation
\code{\link{get_boin_decision}} for decision table generation
\code{\link{get_boin_stopping_boundaries}} for safety stopping boundaries
\code{\link{summarize_simulation_boin}} for summarizing simulation results
}
